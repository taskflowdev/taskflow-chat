<!-- System Message - Centered -->
<div class="system-message" *ngIf="message.isSystemMessage">
  <div class="system-message-content">
    {{ message.content }}
  </div>
</div>

<!-- Regular Message -->
<div class="message-wrapper" [class.own-message]="message.isOwn" [class.is-consecutive]="message.isConsecutive"
  *ngIf="!message.isSystemMessage">
  <!-- Avatar for other messages -->
  <div class="message-avatar" *ngIf="!message.isOwn">
    <div class="avatar-circle">
      <span class="avatar-initials">{{ getInitials(message.senderName) }}</span>
    </div>
  </div>

  <div class="message-bubble">
    <div class="message-header" *ngIf="!message.isConsecutive">
      <span class="sender-name">{{ message.isOwn ? 'You' : (message.senderName || 'Unknown User') }}</span>
      <span class="message-time" appCommonTooltip="{{ getDateTimeTooltip(message.createdAt) }}">{{
        getTimeDisplay(message.createdAt) }}</span>
    </div>

    <!-- Reply button -->
    <button class="reply-btn" (click)="onReplyClick()" appCommonTooltip="Reply to this message"
      *ngIf="!message.isSystemMessage">
      <i class="bi bi-reply"></i>
    </button>

    <!-- Quoted Message Preview -->
    <div class="quoted-message" *ngIf="message.quotedMessage"
      [class.message-unavailable]="!isQuotedMessageAvailable(message.quotedMessage)" (click)="onQuotedMessageClick()">
      <i class="bi bi-quote quoted-icon"></i>
      <div class="quoted-content">
        <div class="quoted-sender" [title]="message.quotedMessage.senderName || 'Unknown User'">{{
          message.quotedMessage.senderName || 'Unknown User' }}</div>
        <div class="quoted-text">
          <i class="bi quoted-type-icon" [ngClass]="{
            'bi-image': message.quotedMessage.contentType === 'image',
            'bi-play-circle': message.quotedMessage.contentType === 'video',
            'bi-bar-chart': message.quotedMessage.contentType === 'poll',
            'bi-paperclip': message.quotedMessage.contentType === 'file'
          }" *ngIf="message.quotedMessage.contentType && message.quotedMessage.contentType !== 'text'"></i>
          {{ getQuotedContentPreview(message.quotedMessage) }}
        </div>
      </div>
    </div>

    <div class="message-content">
      <!-- Text content -->
      <ng-container *ngIf="!message.contentType || message.contentType === 'text'">
        {{ message.content }}
      </ng-container>

      <!-- Image content -->
      <ng-container *ngIf="message.contentType === 'image'">
        <div class="media-message">
          <i class="bi bi-image"></i>
          <span>{{ message.content }}</span>
        </div>
      </ng-container>

      <!-- Video content -->
      <ng-container *ngIf="message.contentType === 'video'">
        <div class="media-message">
          <i class="bi bi-play-circle"></i>
          <span>{{ message.content }}</span>
          <span *ngIf="message.contentData?.duration" class="duration">
            ({{ formatDuration(message.contentData.duration) }})
          </span>
        </div>
      </ng-container>

      <!-- Poll content -->
      <ng-container *ngIf="message.contentType === 'poll'">
        <app-poll-message [groupId]="message.groupId ?? ''" [messageId]="message.messageId"
          [currentUserId]="message.currentUserId ?? ''" [groupMemberCount]="message.groupMemberCount ?? 0"
          [initialPollData]="message.pollData">
        </app-poll-message>
      </ng-container>

      <!-- File content -->
      <ng-container *ngIf="message.contentType === 'file'">
        <div class="file-message">
          <i class="bi bi-file-earmark"></i>
          <span>{{ message.content }}</span>
          <span *ngIf="message.contentData?.fileSize" class="file-size">
            ({{ formatFileSize(message.contentData.fileSize) }})
          </span>
        </div>
      </ng-container>
    </div>
  </div>
</div>