<div class="chat-conversation" *ngIf="conversation || loading; else noConversationSelected">
  <!-- Conversation Header -->
  <div class="conversation-header" *ngIf="conversation && !loading">
    <!-- Mobile Back Button -->
    <button *ngIf="showBackButton" class="back-button" [appCommonTooltip]="'Back to chats'"
      [tooltipPosition]="TooltipPosition.BOTTOM" (click)="onBackClick()">
      <i class="bi bi-arrow-left"></i>
    </button>

    <div class="conversation-info">
      <h4 class="conversation-title">{{ conversation.groupName }}</h4>
      <div class="conversation-subtitle-row">
        <p class="conversation-subtitle" *ngIf="conversation.memberCount">
          {{ conversation.memberCount }} member{{ conversation.memberCount !== 1 ? 's' : '' }}
        </p>
      </div>
    </div>

    <div class="conversation-actions">
      <app-presence-avatars [groupId]="conversation.groupId" [maxVisible]="5">
      </app-presence-avatars>

      <div class="action-divider" *ngIf="conversation.memberCount && conversation.memberCount > 1"></div>

      <app-common-dropdown [items]="dropdownItems" buttonIcon="bi-three-dots-vertical" buttonClass="action-btn"
        [appCommonTooltip]="'chats.conversation-window.header.more-options.title' | translate"
        (itemSelected)="onDropdownItemSelected($event)">
      </app-common-dropdown>
    </div>
  </div>

  <!-- Header Skeleton -->
  <div class="conversation-header" *ngIf="loading">
    <!-- Mobile Back Button Skeleton -->
    <div *ngIf="showBackButton" class="back-button-skeleton">
      <app-skeleton-loader type="circle" width="36px" height="36px"></app-skeleton-loader>
    </div>

    <app-skeleton-loader type="chat-header" [showBackButton]="showBackButton"></app-skeleton-loader>
  </div>

  <!-- Messages Container -->
  <div class="messages-container" #messagesContainer (scroll)="onMessagesScroll()">
    <!-- Loading Messages -->
    <div class="messages-list" *ngIf="loading">
      <app-skeleton-loader *ngFor="let item of messageSkeletonItems; trackBy: trackByMessageIndex" type="message">
      </app-skeleton-loader>
    </div>

    <!-- Loaded Messages -->
    <div class="messages-list" *ngIf="conversation && !loading">
      <ng-container *ngFor="let group of getGroupedMessages(); trackBy: trackByDate">
        <!-- Date Separator -->
        <div class="date-separator">
          <span class="date-label">{{ group.dateLabel }}</span>
        </div>

        <!-- Messages for this date -->
        <app-chat-message *ngFor="let message of group.messages; trackBy: trackByMessageId" [message]="message"
          [attr.data-message-id]="message.messageId" (replyToMessage)="onReplyToMessage($event)"
          (quotedMessageClick)="onQuotedMessageClick($event)">
        </app-chat-message>
      </ng-container>
    </div>

    <!-- Scroll to Bottom Button -->
    <app-scroll-to-bottom-button *ngIf="showScrollButton && conversation && !loading"
      (scrollClick)="onScrollToBottomClick()">
    </app-scroll-to-bottom-button>
  </div>

  <!-- Message Input - Always visible -->
  <div class="message-input-container" [class.has-typing]="shouldShowTypingIndicator">
    <!-- Typing Indicator -->
    <app-typing-indicator *ngIf="shouldShowTypingIndicator" [typingUsers]="typingUsers"></app-typing-indicator>

    <!-- Poll Composer -->
    <app-poll-composer *ngIf="showPollComposer" (pollCreated)="onPollCreated($event)"
      (cancelled)="onPollComposerCancelled()">
    </app-poll-composer>

    <div class="input-wrapper" *ngIf="!showPollComposer">
      <button class="btn attachment-btn" (click)="togglePollComposer()" (mouseenter)="pollBtnHovered = true"
        (mouseleave)="pollBtnHovered = false" [appCommonTooltip]="'Create poll'" [disabled]="loading">
        <i class="bi" [ngClass]="pollBtnHovered ? 'bi-bar-chart-fill' : 'bi-bar-chart'"></i>
      </button>

      <div class="input-with-reply">
        <!-- Reply Preview -->
        <div class="reply-preview" *ngIf="replyingToMessage">
          <div class="reply-preview-content">
            <div class="reply-preview-left">
              <!-- Show appropriate icon based on content type -->
              <i class="bi" [ngClass]="{
                'bi-reply': !replyingToMessage.contentType || replyingToMessage.contentType === 'text',
                'bi-image': replyingToMessage.contentType === 'image',
                'bi-play-circle': replyingToMessage.contentType === 'video',
                'bi-bar-chart': replyingToMessage.contentType === 'poll',
                'bi-paperclip': replyingToMessage.contentType === 'file'
              }"></i>
              <div class="reply-preview-info">
                <div class="reply-preview-header">{{ replyingToMessage.isOwn ? 'You' : (replyingToMessage.senderName ||
                  'Unknown User') }}</div>
                <div class="reply-preview-text">{{ getReplyPreviewText(replyingToMessage) }}</div>
              </div>
            </div>
            <button class="reply-preview-close" (click)="cancelReply()">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        </div>

        <textarea [(ngModel)]="newMessage" (keydown)="onKeyDown($event)"
          [placeholder]="'chats.conversation-window.conversations.composer.placeholder' | translate"
          class="message-input" rows="1" [disabled]="loading">
        </textarea>
      </div>

      <button class="btn send-btn" (click)="onSendMessage()" [disabled]="!newMessage.trim() || loading"
        [appCommonTooltip]="btnSendTooltip">
        <i class="bi" [ngClass]="newMessage.trim() && !loading ? 'bi-send-check' : 'bi-send'"></i>
      </button>
      <ng-template #btnSendTooltip>
        {{ 'chats.conversation-window.conversations.composer.send-button.tooltip.label' | translate }} <span
          class="shortcut-key-tooltip">{{
          'chats.conversation-window.conversations.composer.send-button.tooltip.shortcut' | translate }}</span>
      </ng-template>
    </div>
  </div>
</div>

<ng-template #noConversationSelected>
  <div class="no-conversation">
    <div class="placeholder-content">
      <i class="bi bi-chat-quote placeholder-icon"></i>
      <h3 class="placeholder-title">{{ 'chats.conversation-window.conversations.empty-state.title' | translate }}</h3>
      <p class="placeholder-subtitle">{{ 'chats.conversation-window.conversations.empty-state.subtitle' | translate }}
      </p>
      <p class="placeholder-footer" [appCommonTooltip]="encryptionTooltip" [tooltipPosition]="TooltipPosition.BOTTOM">
        <i class="bi bi-lock"></i> {{ 'chats.conversation-window.conversations.empty-state.encryption.title' | translate
        }}
      </p>
    </div>
  </div>
  <ng-template #encryptionTooltip>
    <div class="p-1">
      <strong class="fs-6">
        <i class="bi bi-lock-fill"></i>
        {{ 'chats.conversation-window.conversations.empty-state.encryption.tooltip.title' | translate }}
      </strong>
      <p>{{ 'chats.conversation-window.conversations.empty-state.encryption.tooltip.text' | translate }}</p>
    </div>
  </ng-template>
</ng-template>

<!-- Group Info Dialog -->
<app-group-info-dialog *ngIf="showGroupInfoDialog && conversation" [groupId]="conversation.groupId"
  [currentUserId]="currentUserId || ''" [triggerDelete]="openGroupInfoForDeletion" (closed)="onGroupInfoClosed()"
  (updated)="onGroupInfoUpdated()" (deleted)="onGroupDeleted($event)">
</app-group-info-dialog>