<div class="chat-conversation" *ngIf="conversation || loading; else noConversationSelected">
  <!-- Conversation Header -->
  <div class="conversation-header" *ngIf="conversation && !loading">
    <!-- Mobile Back Button -->
    <button *ngIf="showBackButton" class="back-button"
      [appCommonTooltip]="'Back to chats'"
      [tooltipPosition]="TooltipPosition.BOTTOM"
      (click)="onBackClick()">
      <i class="bi bi-arrow-left"></i>
    </button>

    <div class="conversation-info">
      <h4 class="conversation-title">{{ conversation.groupName }}</h4>
      <p class="conversation-subtitle" *ngIf="conversation.memberCount">
        {{ conversation.memberCount }} member{{ conversation.memberCount !== 1 ? 's' : '' }}
      </p>
    </div>

    <div class="conversation-actions">
      <app-common-dropdown
        [items]="dropdownItems"
        buttonIcon="bi-three-dots-vertical"
        buttonClass="action-btn"
        [appCommonTooltip]="'More options'"
        (itemSelected)="onDropdownItemSelected($event)">
      </app-common-dropdown>
    </div>
  </div>

  <!-- Header Skeleton -->
  <div class="conversation-header" *ngIf="loading">
    <!-- Mobile Back Button Skeleton -->
    <div *ngIf="showBackButton" class="back-button-skeleton">
      <app-skeleton-loader type="circle" width="36px" height="36px"></app-skeleton-loader>
    </div>

    <app-skeleton-loader type="chat-header" [showBackButton]="showBackButton"></app-skeleton-loader>
  </div>

  <!-- Messages Container -->
  <div class="messages-container" #messagesContainer (scroll)="onMessagesScroll()">
    <!-- Loading Messages -->
    <div class="messages-list" *ngIf="loading">
      <app-skeleton-loader
        *ngFor="let item of messageSkeletonItems; trackBy: trackByMessageIndex"
        type="message">
      </app-skeleton-loader>
    </div>

    <!-- Loaded Messages -->
    <div class="messages-list" *ngIf="conversation && !loading">
      <ng-container *ngFor="let group of getGroupedMessages(); trackBy: trackByDate">
        <!-- Date Separator -->
        <div class="date-separator">
          <span class="date-label">{{ group.dateLabel }}</span>
        </div>

        <!-- Messages for this date -->
        <app-chat-message *ngFor="let message of group.messages; trackBy: trackByMessageId"
          [message]="message">
        </app-chat-message>
      </ng-container>
    </div>

    <!-- Scroll to Bottom Button -->
    <app-scroll-to-bottom-button
      *ngIf="showScrollButton && conversation && !loading"
      (scrollClick)="onScrollToBottomClick()">
    </app-scroll-to-bottom-button>
  </div>

  <!-- Message Input - Always visible -->
  <div class="message-input-container" [class.has-typing]="typingUsersText">
    <!-- Typing Indicator -->
    <div class="typing-indicator" *ngIf="typingUsersText">
      <div class="typing-dots">
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
      </div>
      <span class="typing-text">{{ typingUsersText }}</span>
    </div>

    <div class="input-wrapper">
      <textarea [(ngModel)]="newMessage" (keydown)="onKeyDown($event)"
        placeholder="Type a message..."
        class="message-input"
        rows="1"
        [disabled]="loading">
      </textarea>
      <button class="btn send-btn" (click)="onSendMessage()" [disabled]="!newMessage.trim() || loading"
        [appCommonTooltip]="btnSendTooltip">
        <i class="bi" [ngClass]="newMessage.trim() && !loading ? 'bi-send-check' : 'bi-send'"></i>
      </button>
      <ng-template #btnSendTooltip>
        Send <span class="shortcut-key-tooltip">Enter</span>
      </ng-template>
    </div>
  </div>
</div>

<ng-template #noConversationSelected>
  <div class="no-conversation">
    <div class="placeholder-content">
      <i class="bi bi-chat-quote placeholder-icon"></i>
      <h3 class="placeholder-title">No Chat Selected</h3>
      <p class="placeholder-subtitle">Pick a chat to continue</p>
      <p class="placeholder-footer" [appCommonTooltip]="encryptionTooltip" [tooltipPosition]="TooltipPosition.BOTTOM">
        <i class="bi bi-lock"></i> Messages are end-to-end encrypted
      </p>
    </div>
  </div>
  <ng-template #encryptionTooltip>
    <div class="p-1">
      <strong class="fs-6">
        <i class="bi bi-lock-fill"></i>
        End-to-End Encryption
      </strong>
      <p>Only you and the recipient can read these messages. Data is encrypted on your device and decrypted on the
        recipientâ€™s device.</p>
    </div>
  </ng-template>
</ng-template>

<!-- Group Info Dialog -->
<app-group-info-dialog
  *ngIf="showGroupInfoDialog && conversation"
  [groupId]="conversation.groupId"
  [currentUserId]="currentUserId || ''"
  [triggerDelete]="openGroupInfoForDeletion"
  (closed)="onGroupInfoClosed()"
  (updated)="onGroupInfoUpdated()"
  (deleted)="onGroupDeleted($event)">
</app-group-info-dialog>
