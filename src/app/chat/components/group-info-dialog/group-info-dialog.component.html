<div class="dialog-overlay" (click)="closeDialog()" role="dialog" aria-labelledby="dialog-title" aria-modal="true">
  <div class="dialog-container" (click)="$event.stopPropagation()">
    <!-- Dialog Header -->
    <div class="dialog-header">
      <div class="dialog-header-text">
        <h1 id="dialog-title" class="dialog-title">
          Group Information
        </h1>
        <p id="dialog-subtitle" class="dialog-subtitle">
          Update group settings and keep information organized.
        </p>
      </div>

      <button type="button" class="close-btn" (click)="closeDialog()" aria-label="Close dialog">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <!-- Dialog Body with Tabs -->
    <div class="dialog-body">
      <!-- Loading State -->
      <div *ngIf="isLoadingGroup" class="dialog-content-grid skeleton-layout">

        <!-- left tabs skeleton -->
        <div class="tabs-column">
          <app-skeleton-loader type="rectangle" width="100%" height="40px"></app-skeleton-loader>
          <app-skeleton-loader type="rectangle" width="100%" height="40px"></app-skeleton-loader>
          <app-skeleton-loader type="rectangle" width="100%" height="40px"></app-skeleton-loader>
        </div>
        <!-- right content minimal skeleton -->
        <div class="content-column">
          <app-skeleton-loader type="rectangle" width="100%" height="100%"></app-skeleton-loader>
        </div>

      </div>

      <!-- Loaded Content -->
      <div *ngIf="!isLoadingGroup" class="dialog-content-grid">
        <!-- Left Column: Tabs -->
        <div class="tabs-column">
          <app-tabs [tabs]="tabs" [activeTabId]="activeTab" [orientation]="'vertical'"
            (tabChange)="onTabChange($event)">
          </app-tabs>
        </div>

        <!-- Right Column: Tab Content -->
        <div class="content-column">
          <!-- General Tab -->
          <div *ngIf="activeTab === 'general'" id="tabpanel-general" role="tabpanel" aria-labelledby="tab-general"
            class="tab-content">
            <form [formGroup]="groupInfoForm" (ngSubmit)="onSubmit()" novalidate>
              <!-- Group Avatar -->
              <div class="group-avatar-section">
                <div class="avatar-info">
                  <div class="avatar-circle">
                    <i class="bi bi-people"></i>
                  </div>
                  <div class="avatar-text">
                    <h5 class="avatar-group-name">{{ group?.name }}</h5>
                    <p class="group-member-count">{{ group?.memberCount || 0 }} {{ group?.memberCount === 1 ? 'Member' :
                      'Members' }}</p>
                    </div>
                    </div>
                    <div class="avatar-actions">
                      <i class="bi bi-clock-history" appCommonTooltip="Created on {{ getDateTimeTooltip(group?.createdAt) }}">
                      </i>
                    </div>
              </div>

              <!-- Group Name Field -->
              <app-common-input label="Group Name" placeholder="Enter group name" formControlName="groupName"
                [isInvalid]="getFieldError('groupName')" [errorMessage]="getErrorMessage('groupName')">
              </app-common-input>

              <!-- Metadata -->
              <div class="info-section-card">
                <!-- <span class="info-item" title="Number of Group Members">
                  <i class="bi bi-people-fill me-1"></i>
                  {{ group?.memberCount || 0 }} {{ group?.memberCount === 1 ? 'Member' : 'Members' }}
                </span>
                <span class="info-item" title="Group Created Date">
                  <i class="bi bi-clock-history me-1"></i>
                  {{ group?.createdAt | date: 'shortDate' }}
                </span> -->
              </div>

              <!-- Update Button -->
              <app-common-button type="submit" variant="primary" size="small" [fullWidth]="true" [loading]="isUpdating"
                [disabled]="groupInfoForm.invalid || groupInfoForm.pristine">
                {{ isUpdating ? 'Updating...' : 'Update Group' }}
              </app-common-button>
            </form>
          </div>

          <!-- Members Tab -->
          <div *ngIf="activeTab === 'members'" id="tabpanel-members" role="tabpanel" aria-labelledby="tab-members"
            class="tab-content">
            <h3 class="tab-title">Members</h3>
            <p class="tab-description">Manage members and their roles in this group.</p>

            <app-compact-member-list [members]="members" [isLoading]="isLoadingMembers" [isActionAllowed]="isAdmin"
              [currentUserId]="currentUserId" [processingUserId]="processingUserId" (makeAdmin)="onMakeAdmin($event)"
              (removeMember)="onRemoveMember($event)" (memberClick)="onMemberClick($event)">
            </app-compact-member-list>
          </div>

          <!-- Settings Tab -->
          <div *ngIf="activeTab === 'settings'" id="tabpanel-settings" role="tabpanel" aria-labelledby="tab-settings"
            class="tab-content">
            <h3 class="tab-title">Settings</h3>
            <p class="tab-description">Manage advanced group settings and danger actions.</p>

            <div class="danger-zone">

              <div class="danger-zone-header">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <span>Danger Zone</span>
              </div>

              <div class="danger-zone-content">

                <!-- Change Visibility -->
                <div class="danger-action">
                  <div class="danger-action-info">
                    <h4>Change Visibility</h4>
                    <p>Make this group {{ group?.isPublic ? 'private' : 'public' }}. {{ group?.isPublic ? 'Only members will be able to access it.' : 'Anyone will be able to view and join it.' }}</p>
                  </div>
                  <!-- visibility toggle btn -->
                  <ng-container *ngIf="isLoadingMembers; else visibilityBtnLoaded">
                    <app-skeleton-loader type="rectangle" width="140px" height="36px"></app-skeleton-loader>
                  </ng-container>

                  <ng-template #visibilityBtnLoaded>
                    <app-common-button
                      type="button"
                      variant="secondary"
                      size="small"
                      [appCommonTooltip]="changeVisibilityTooltip"
                      [disabled]="!isAdmin || isUpdatingVisibility"
                      (clicked)="onVisibilityToggle()">
                      <i class="bi {{ group?.isPublic ? 'bi-eye-slash' : 'bi-eye' }} me-2"></i>{{ group?.isPublic ? 'Make Private' : 'Make Public' }}
                    </app-common-button>
                  </ng-template>
                </div>

                <div class="danger-action">
                  <div class="danger-action-info">
                    <h4>Leave Group</h4>
                    <p>Remove yourself from this group and lose access to all content.</p>
                  </div>
                  <!-- leave btn -->
                  <ng-container *ngIf="isLoadingMembers; else leaveBtnLoaded">
                    <app-skeleton-loader type="rectangle" width="120px" height="36px"></app-skeleton-loader>
                  </ng-container>

                  <ng-template #leaveBtnLoaded>
                    <app-common-button type="button" variant="warning" size="small" [appCommonTooltip]="leaveGroupTooltip"
                      [disabled]="isLastAdmin || isLeaving" (clicked)="onLeaveClick()">
                      <i class="bi bi-box-arrow-right me-2"></i>Leave Group
                    </app-common-button>
                  </ng-template>
                </div>

                <div class="danger-action">
                  <div class="danger-action-info">
                    <h4>Delete Group</h4>
                    <p>Permanently delete this group and all its data.</p>
                  </div>
                  <!-- delete btn -->
                  <ng-container *ngIf="isLoadingMembers; else deleteBtnLoaded">
                    <app-skeleton-loader type="rectangle" width="100px" height="36px"></app-skeleton-loader>
                  </ng-container>

                  <ng-template #deleteBtnLoaded>
                    <app-common-button type="button" variant="danger" size="small" [appCommonTooltip]="deleteGroupTooltip"
                      [disabled]="!isAdmin || isDeleting" (clicked)="onDeleteClick()">
                      <i class="bi bi-trash me-2"></i>Delete
                    </app-common-button>
                  </ng-template>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dialog Footer -->
    <div class="dialog-footer">
      <app-common-button type="button" variant="secondary" (clicked)="closeDialog()">
        Close
      </app-common-button>
    </div>
  </div>
</div>


<!-- Remove Member Confirmation Dialog -->
<app-confirmation-dialog [isVisible]="showRemoveMemberConfirmation" [title]="'Remove Member?'"
  [message]="'Are you sure you want to remove ' + (memberToRemove?.fullName || memberToRemove?.userName) + ' from this group?'"
  [secondaryMessage]="'They will lose access to all group messages and content.'" [confirmText]="'Remove Member'"
  [cancelText]="'Cancel'" [variant]="'danger'" [icon]="'bi-person-x'" [loading]="processingUserId !== null"
  (confirmed)="confirmRemoveMember()" (cancelled)="cancelRemoveMember()">
</app-confirmation-dialog>

<!-- Leave Group Confirmation Dialog -->
<app-confirmation-dialog [isVisible]="showLeaveConfirmation" [title]="'Leave Group?'"
  [message]="'Are you sure you want to leave this group?'"
  [secondaryMessage]="'You will lose access to all group messages and content. You can rejoin later if you have an invite code.'"
  [confirmText]="'Leave Group'" [cancelText]="'Stay in Group'" [variant]="'warning'" [icon]="'bi-box-arrow-right'"
  [loading]="isLeaving" (confirmed)="confirmLeave()" (cancelled)="cancelLeave()">
</app-confirmation-dialog>

<!-- Change Visibility Confirmation Dialog -->
<app-confirmation-dialog
  [isVisible]="showVisibilityConfirmation"
  [title]="'Change Group Visibility?'"
  [message]="'Are you sure you want to make this group ' + (pendingVisibilityValue ? 'public' : 'private') + '?'"
  [secondaryMessage]="pendingVisibilityValue ? 'Anyone will be able to view and join this group.' : 'Only existing members will be able to access this group.'"
  [confirmText]="'Change Visibility'"
  [cancelText]="'Cancel'"
  [variant]="'warning'"
  [icon]="pendingVisibilityValue ? 'bi-eye' : 'bi-eye-slash'"
  [loading]="isUpdatingVisibility"
  (confirmed)="confirmVisibilityChange()"
  (cancelled)="cancelVisibilityChange()">
</app-confirmation-dialog>

<!-- Delete Group Confirmation Dialog -->
<app-confirmation-dialog [isVisible]="showDeleteConfirmation" [title]="'Delete Group?'"
  [message]="'This action cannot be undone. All messages, files, and group data will be permanently deleted.'"
  [secondaryMessage]="'All members will lose access to this group immediately.'" [confirmText]="'Delete Group'"
  [cancelText]="'Keep Group'" [variant]="'danger'" [icon]="'bi-trash'" [loading]="isDeleting"
  (confirmed)="confirmDelete()" (cancelled)="cancelDelete()">
</app-confirmation-dialog>
