<div class="dialog-overlay" (click)="closeDialog()" role="dialog" aria-labelledby="dialog-title" aria-modal="true">
  <div class="dialog-container" (click)="$event.stopPropagation()">
    <!-- Dialog Header -->
    <div class="dialog-header">
      <div class="dialog-header-text">
        <h1 id="dialog-title" class="dialog-title">
          {{ 'dialogs.group-information.title' | translate }}
        </h1>
        <p id="dialog-subtitle" class="dialog-subtitle">
          {{ 'dialogs.group-information.subtitle' | translate }}
        </p>
      </div>

      <button type="button" class="close-btn" (click)="closeDialog()" aria-label="Close dialog">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <!-- Dialog Body with Tabs -->
    <div class="dialog-body">
      <!-- Loading State -->
      <div *ngIf="isLoadingGroup" class="dialog-content-grid skeleton-layout">

        <!-- left tabs skeleton -->
        <div class="tabs-column">
          <app-skeleton-loader type="rectangle" width="100%" height="40px"></app-skeleton-loader>
          <app-skeleton-loader type="rectangle" width="100%" height="40px"></app-skeleton-loader>
          <app-skeleton-loader type="rectangle" width="100%" height="40px"></app-skeleton-loader>
          <app-skeleton-loader type="rectangle" width="100%" height="40px"></app-skeleton-loader>
        </div>
        <!-- right content minimal skeleton -->
        <div class="content-column">
          <app-skeleton-loader type="rectangle" width="100%" height="100%"></app-skeleton-loader>
        </div>

      </div>

      <!-- Loaded Content -->
      <div *ngIf="!isLoadingGroup" class="dialog-content-grid">
        <!-- Left Column: Tabs -->
        <div class="tabs-column">
          <app-tabs [tabs]="tabs" [activeTabId]="activeTab" [orientation]="'vertical'"
            (tabChange)="onTabChange($event)">
          </app-tabs>
        </div>

        <!-- Right Column: Tab Content -->
        <div class="content-column">
          <!-- General Tab -->
          <div *ngIf="activeTab === 'general'" id="tabpanel-general" role="tabpanel" aria-labelledby="tab-general"
            class="tab-content">
            <!-- Group Avatar -->
            <div class="group-avatar-section">
              <div class="avatar-info">
                <div class="avatar-circle">
                  <i class="bi bi-people"></i>
                </div>
                <div class="avatar-text">
                  <h5 class="avatar-group-name">{{ group?.name }}</h5>
                  <p class="group-member-count">{{ group?.memberCount === 1 ?
                    ('dialogs.group-information.tabs.general.info-avatar.member-count-singular' | translate) :
                    ('dialogs.group-information.tabs.general.info-avatar.member-count-plural' | translate:{ count:
                    group?.memberCount || 0 }) }}</p>
                </div>
              </div>
              <div class="avatar-actions">
                <i class="bi bi-clock-history"
                  [appCommonTooltip]="'dialogs.group-information.tabs.general.info-avatar.history-btn.tooltip' | translate:{ 'date-time': getDateTimeTooltip(group?.createdAt) }">
                </i>
              </div>
            </div>

            <div class="section-divider"></div>

            <div class="group-info-form">
              <form [formGroup]="groupInfoForm" (ngSubmit)="onSubmit()" novalidate>
                <!-- Group Name Field -->
                <app-common-input
                  [label]="'dialogs.group-information.tabs.general.controls.group-name.label' | translate"
                  [placeholder]="'dialogs.group-information.tabs.general.controls.group-name.placeholder' | translate"
                  formControlName="groupName" [isInvalid]="getFieldError('groupName')"
                  [errorMessage]="getErrorMessage('groupName')">
                </app-common-input>
              </form>
            </div>

            <div class="group-info-actions">
              <app-common-button type="submit" variant="primary" size="small" [fullWidth]="true" [loading]="isUpdating"
                [disabled]="groupInfoForm.invalid || groupInfoForm.pristine">
                {{ isUpdating ? ('dialogs.group-information.tabs.general.actions.update-button.loading-label' |
                translate) : ('dialogs.group-information.tabs.general.actions.update-button.label' | translate) }}
              </app-common-button>
            </div>
          </div>

          <!-- Members Tab -->
          <div *ngIf="activeTab === 'members'" id="tabpanel-members" role="tabpanel" aria-labelledby="tab-members"
            class="tab-content">
            <h3 class="tab-title">{{ 'dialogs.group-information.tabs.members.title' | translate }}</h3>
            <p class="tab-description">{{ 'dialogs.group-information.tabs.members.subtitle' | translate }}</p>

            <app-compact-member-list [members]="members" [isLoading]="isLoadingMembers" [isActionAllowed]="isAdmin"
              [currentUserId]="currentUserId" [processingUserId]="processingUserId" (makeAdmin)="onMakeAdmin($event)"
              (removeMember)="onRemoveMember($event)" (memberClick)="onMemberClick($event)">
            </app-compact-member-list>
          </div>

          <!-- Invite Tab -->
          <div *ngIf="activeTab === 'invite'" id="tabpanel-invite" role="tabpanel" aria-labelledby="tab-invite"
            class="tab-content">
            <h3 class="tab-title">{{ 'dialogs.group-information.tabs.invite.title' | translate }}</h3>
            <p class="tab-description">{{ 'dialogs.group-information.tabs.invite.subtitle' | translate }}</p>

            <div class="invite-section" *ngIf="isAdmin">
              <div class="invite-header">
                <h4>{{ 'dialogs.group-information.tabs.invite.section.title' | translate }}</h4>
                <p>{{ 'dialogs.group-information.tabs.invite.section.subtitle' | translate }}</p>
              </div>

              <div class="invite-fields">
                <div class="invite-field">
                  <label class="invite-label">{{ 'dialogs.group-information.tabs.invite.code.label' | translate
                    }}</label>
                  <div class="invite-value">
                    <input class="invite-input" type="text"
                      [value]="inviteCodeValue || ('dialogs.group-information.tabs.invite.code.unavailable' | translate)"
                      [class.is-placeholder]="!inviteCodeValue" readonly aria-label="Invite code" />
                    <app-common-button type="button" variant="secondary" size="small" [disabled]="!inviteCodeValue"
                      (clicked)="copyInviteCode()">
                      <i class="bi bi-clipboard me-2"></i>{{
                      'dialogs.group-information.tabs.invite.code.copy-button.label' | translate }}
                    </app-common-button>
                  </div>
                </div>
              </div>

              <div class="invite-actions">
                <app-common-button type="button" variant="primary" size="small" [loading]="isRegeneratingInvite"
                  [disabled]="isRegeneratingInvite" (clicked)="onRegenerateInviteClick()">
                  <i class="bi bi-arrow-repeat me-2"></i>{{ isRegeneratingInvite ?
                  ('dialogs.group-information.tabs.invite.regenerate.loading-label' | translate) :
                  ('dialogs.group-information.tabs.invite.regenerate.label' | translate) }}
                </app-common-button>
                <p class="invite-hint">
                  {{ 'dialogs.group-information.tabs.invite.regenerate.hint' | translate }}
                </p>
              </div>
            </div>

            <div class="non-admin-message" *ngIf="!isAdmin">
              <p class="message-text">
                {{ 'dialogs.group-information.tabs.invite.non-admin-message' | translate }}
              </p>
            </div>
          </div>

          <!-- Settings Tab -->
          <div *ngIf="activeTab === 'settings'" id="tabpanel-settings" role="tabpanel" aria-labelledby="tab-settings"
            class="tab-content">
            <h3 class="tab-title">{{ 'dialogs.group-information.tabs.settings.title' | translate }}</h3>
            <p class="tab-description">{{ 'dialogs.group-information.tabs.settings.subtitle' | translate }}</p>

            <div class="danger-zone">

              <div class="danger-zone-header">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <span>{{ 'dialogs.group-information.tabs.settings.danger-zone.title' | translate }}</span>
              </div>

              <div class="danger-zone-content">

                <!-- Change Visibility -->
                <div class="danger-action">
                  <div class="danger-action-info">
                    <h4>{{ 'dialogs.group-information.tabs.settings.danger-zone.change-visibility.title' | translate }}
                    </h4>
                    <p>{{ 'dialogs.group-information.tabs.settings.danger-zone.change-visibility.description' |
                      translate }}</p>
                  </div>
                  <!-- visibility toggle btn -->
                  <ng-container *ngIf="isLoadingMembers; else visibilityBtnLoaded">
                    <app-skeleton-loader type="rectangle" width="140px" height="36px"></app-skeleton-loader>
                  </ng-container>

                  <ng-template #visibilityBtnLoaded>
                    <app-common-button type="button" variant="danger" size="small"
                      [appCommonTooltip]="changeVisibilityTooltip" [disabled]="!isAdmin || isUpdatingVisibility"
                      (clicked)="onVisibilityToggle()">
                      <i class="bi {{ group?.isPublic ? 'bi-eye-slash' : 'bi-eye' }} me-2"></i>{{ group?.isPublic ?
                      ('dialogs.group-information.tabs.settings.danger-zone.change-visibility.actions.change-visibility-button.label.public'
                      | translate) :
                      ('dialogs.group-information.tabs.settings.danger-zone.change-visibility.actions.change-visibility-button.label.private'
                      | translate) }}
                    </app-common-button>
                  </ng-template>
                </div>

                <div class="danger-action">
                  <div class="danger-action-info">
                    <h4>{{ 'dialogs.group-information.tabs.settings.danger-zone.leave-group.title' | translate }}</h4>
                    <p>{{ 'dialogs.group-information.tabs.settings.danger-zone.leave-group.description' | translate }}
                    </p>
                  </div>

                  <!-- leave btn -->
                  <ng-container *ngIf="isLoadingMembers; else leaveBtnLoaded">
                    <app-skeleton-loader type="rectangle" width="120px" height="36px"></app-skeleton-loader>
                  </ng-container>

                  <ng-template #leaveBtnLoaded>
                    <app-common-button type="button" variant="danger" size="small"
                      [appCommonTooltip]="leaveGroupTooltip" [disabled]="isLastAdmin || isLeaving"
                      (clicked)="onLeaveClick()">
                      <i class="bi bi-box-arrow-right me-2"></i>{{
                      'dialogs.group-information.tabs.settings.danger-zone.leave-group.actions.leave-group-button.label'
                      | translate }}
                    </app-common-button>
                  </ng-template>
                </div>

                <div class="danger-action">
                  <div class="danger-action-info">
                    <h4>{{ 'dialogs.group-information.tabs.settings.danger-zone.delete-group.title' | translate }}</h4>
                    <p>{{ 'dialogs.group-information.tabs.settings.danger-zone.delete-group.description' | translate }}
                    </p>
                  </div>
                  <!-- delete btn -->
                  <ng-container *ngIf="isLoadingMembers; else deleteBtnLoaded">
                    <app-skeleton-loader type="rectangle" width="100px" height="36px"></app-skeleton-loader>
                  </ng-container>

                  <ng-template #deleteBtnLoaded>
                    <app-common-button type="button" variant="danger" size="small"
                      [appCommonTooltip]="deleteGroupTooltip" [disabled]="!isAdmin || isDeleting"
                      (clicked)="onDeleteClick()">
                      <i class="bi bi-trash me-2"></i>{{
                      'dialogs.group-information.tabs.settings.danger-zone.delete-group.actions.delete-button.label' |
                      translate }}
                    </app-common-button>
                  </ng-template>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dialog Footer -->
    <div class="dialog-footer">
      <app-common-button type="button" variant="secondary" (clicked)="closeDialog()">
        {{ 'dialogs.group-information.footer.actions.close-button' | translate }}
      </app-common-button>
    </div>
  </div>
</div>


<!-- Remove Member Confirmation Dialog -->
<app-confirmation-dialog [isVisible]="showRemoveMemberConfirmation" [title]="'Remove Member'"
  [message]="'Are you sure you want to remove ' + (memberToRemove?.fullName || memberToRemove?.userName) + ' from this group?'"
  [secondaryMessage]="'They will lose access to all group messages and content.'" [confirmText]="'Remove Member'"
  [cancelText]="'Cancel'" [variant]="'danger'" [icon]="'bi-person-x'" [loading]="processingUserId !== null"
  (confirmed)="confirmRemoveMember()" (cancelled)="cancelRemoveMember()">
</app-confirmation-dialog>

<!-- Leave Group Confirmation Dialog -->
<app-confirmation-dialog [isVisible]="showLeaveConfirmation" [title]="'Leave Group'"
  [message]="'Are you sure you want to leave this group?'"
  [secondaryMessage]="'You will lose access to all group messages and content. You can rejoin later if group visibility is public.'"
  [confirmText]="'Leave Group'" [cancelText]="'Stay in Group'" [variant]="'danger'" [icon]="'bi-box-arrow-right'"
  [loading]="isLeaving" (confirmed)="confirmLeave()" (cancelled)="cancelLeave()">
</app-confirmation-dialog>

<!-- Change Visibility Confirmation Dialog -->
<app-confirmation-dialog [isVisible]="showVisibilityConfirmation" [title]="'Change Group Visibility'"
  [message]="'Are you sure you want to make this group ' + (pendingVisibilityValue ? 'public' : 'private') + '?'"
  [secondaryMessage]="pendingVisibilityValue ? 'Anyone will be able to view and join this group.' : 'Only existing members will be able to access this group.'"
  [confirmText]="'Change Visibility'" [cancelText]="'Cancel'" [variant]="'danger'"
  [icon]="pendingVisibilityValue ? 'bi-eye' : 'bi-eye-slash'" [loading]="isUpdatingVisibility"
  (confirmed)="confirmVisibilityChange()" (cancelled)="cancelVisibilityChange()">
</app-confirmation-dialog>

<!-- Delete Group Confirmation Dialog -->
<app-confirmation-dialog [isVisible]="showDeleteConfirmation" [title]="'Delete Group'"
  [message]="'This action cannot be undone. All messages, files, and group data will be permanently deleted.'"
  [secondaryMessage]="'All members will lose access to this group immediately.'" [confirmText]="'Delete Group'"
  [cancelText]="'Keep Group'" [variant]="'danger'" [icon]="'bi-trash'" [loading]="isDeleting"
  (confirmed)="confirmDelete()" (cancelled)="cancelDelete()">
</app-confirmation-dialog>

<!-- Regenerate Invite Code Confirmation Dialog -->
<app-confirmation-dialog [isVisible]="showRegenerateInviteConfirmation" [title]="'Regenerate Invite Code'"
  [message]="'Are you sure you want to regenerate the invite code?'"
  [secondaryMessage]="'The previous invite code will stop working immediately.'" [confirmText]="'Regenerate Code'"
  [cancelText]="'Cancel'" [variant]="'danger'" [icon]="'bi-arrow-repeat'" [loading]="isRegeneratingInvite"
  (confirmed)="confirmRegenerateInvite()" (cancelled)="cancelRegenerateInvite()">
</app-confirmation-dialog>