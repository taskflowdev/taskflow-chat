<div class="auth-container">
  <!-- Brand Logo -->
  <a routerLink="/">
    <div class="brand-logo">
      <div class="logo-icon">
        <i class="bi bi-chat-quote"></i>
      </div>
    </div>
  </a>

  <div class="auth-content">
    <div class="auth-form">

      <!-- Loading State - Validating Token -->
      <div *ngIf="isValidatingToken" class="loading-state">
        <div class="auth-header">
          <div class="fs-1 mb-2">
            <i class="bi bi-shield-lock"></i>
          </div>
          <h1 class="main-title">Validating Reset Link</h1>
          <p class="subtitle">Please wait while we verify your password reset link...</p>
        </div>
        <div class="spinner-container">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>

      <!-- Error State - Invalid/Expired Token -->
      <div *ngIf="!isValidatingToken && !tokenValid" class="error-state">
        <div class="auth-header">
          <div class="fs-1 mb-2 text-danger">
            <i class="bi bi-exclamation-triangle-fill"></i>
          </div>
          <h1 class="main-title">Invalid Reset Link</h1>
          <p class="subtitle">{{ errorMessage }}</p>
        </div>

        <div class="error-box">
          <i class="bi bi-info-circle-fill me-2"></i>
          <span>Password reset links expire after 1 hour for security reasons.</span>
        </div>

        <div class="button-group">
          <button type="button" class="btn btn-primary" (click)="requestNewResetLink()">
            <span class="btn-content">
              <span class="btn-text">
                <i class="bi bi-envelope me-2"></i>
                Request New Reset Link
              </span>
            </span>
          </button>
          <button type="button" class="btn btn-secondary" (click)="goToLogin()">
            <span class="btn-content">
              <span class="btn-text">
                <i class="bi bi-arrow-left me-2"></i>
                Back to Login
              </span>
            </span>
          </button>
        </div>
      </div>

      <!-- Success State -->
      <div *ngIf="isSuccess" class="success-state">
        <div class="auth-header">
          <div class="fs-1 mb-2 text-success">
            <i class="bi bi-check-circle-fill"></i>
          </div>
          <h1 class="main-title">Password Reset Successful!</h1>
          <p class="subtitle">Your password has been changed successfully. Redirecting you to login...</p>
        </div>

        <div class="success-box">
          <i class="bi bi-info-circle-fill me-2"></i>
          <span>You can now sign in with your new password.</span>
        </div>

        <a routerLink="/auth/signin" class="btn btn-primary">
          <span class="btn-content">
            <span class="btn-text">
              Continue to Login
            </span>
            <span class="btn-icon">
              <i class="bi bi-arrow-right-circle-fill"></i>
            </span>
          </span>
        </a>
      </div>

      <!-- Reset Form - Valid Token -->
      <div *ngIf="!isValidatingToken && tokenValid && !isSuccess">
        <div class="auth-header">
          <div class="fs-1 mb-2">
            <i class="bi bi-shield-lock-fill"></i>
          </div>
          <h1 class="main-title">Reset Your Password</h1>
          <p class="subtitle">Enter your new password below</p>
        </div>

        <!-- Error Message -->
        <div *ngIf="errorMessage" class="error-banner">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          {{ errorMessage }}
        </div>

        <form [formGroup]="resetPasswordForm" (ngSubmit)="onSubmit()" novalidate>
          <!-- New Password Field -->
          <div class="form-group">
            <label for="newPassword" class="form-label">New Password</label>
            <div class="password-input-wrapper">
              <input 
                [type]="showPassword ? 'text' : 'password'"
                class="form-control"
                [class.is-invalid]="getFieldError('newPassword')"
                id="newPassword"
                formControlName="newPassword"
                placeholder="Enter new password"
                autocomplete="new-password">
              <button 
                type="button" 
                class="password-toggle"
                (click)="togglePasswordVisibility('password')"
                [attr.aria-label]="showPassword ? 'Hide password' : 'Show password'">
                <i class="bi" [ngClass]="showPassword ? 'bi-eye-slash' : 'bi-eye'"></i>
              </button>
            </div>
          </div>

          <!-- Password Strength Indicator -->
          <div class="password-strength-meter" *ngIf="resetPasswordForm.get('newPassword')?.value">
            <div class="strength-bar">
              <div 
                class="strength-fill" 
                [style.width.%]="(getPasswordStrength().strength / 5) * 100"
                [style.background-color]="getPasswordStrength().color">
              </div>
            </div>
            <span class="strength-label" [style.color]="getPasswordStrength().color">
              {{ getPasswordStrength().label }}
            </span>
          </div>

          <!-- Password Requirements -->
          <div class="password-requirements">
            <p class="requirements-title">Password must contain:</p>
            <ul class="requirements-list">
              <li [class.met]="hasMinLength()">
                <i class="bi" [ngClass]="hasMinLength() ? 'bi-check-circle-fill' : 'bi-circle'"></i>
                At least {{ passwordPolicy.minLength }} characters
              </li>
              <li [class.met]="hasUpperCase()">
                <i class="bi" [ngClass]="hasUpperCase() ? 'bi-check-circle-fill' : 'bi-circle'"></i>
                One uppercase letter
              </li>
              <li [class.met]="hasLowerCase()">
                <i class="bi" [ngClass]="hasLowerCase() ? 'bi-check-circle-fill' : 'bi-circle'"></i>
                One lowercase letter
              </li>
              <li [class.met]="hasNumber()">
                <i class="bi" [ngClass]="hasNumber() ? 'bi-check-circle-fill' : 'bi-circle'"></i>
                One number
              </li>
              <li [class.met]="hasSpecialChar()">
                <i class="bi" [ngClass]="hasSpecialChar() ? 'bi-check-circle-fill' : 'bi-circle'"></i>
                One special character
              </li>
            </ul>
          </div>

          <!-- Confirm Password Field -->
          <div class="form-group">
            <label for="confirmPassword" class="form-label">Confirm Password</label>
            <div class="password-input-wrapper">
              <input 
                [type]="showConfirmPassword ? 'text' : 'password'"
                class="form-control"
                [class.is-invalid]="getFieldError('confirmPassword')"
                id="confirmPassword"
                formControlName="confirmPassword"
                placeholder="Confirm new password"
                autocomplete="new-password">
              <button 
                type="button" 
                class="password-toggle"
                (click)="togglePasswordVisibility('confirmPassword')"
                [attr.aria-label]="showConfirmPassword ? 'Hide password' : 'Show password'">
                <i class="bi" [ngClass]="showConfirmPassword ? 'bi-eye-slash' : 'bi-eye'"></i>
              </button>
            </div>
            <div *ngIf="getFieldError('confirmPassword')" class="field-error">
              {{ getFieldError('confirmPassword') }}
            </div>
          </div>

          <!-- Reset Password Button -->
          <button 
            type="submit" 
            class="btn btn-reset"
            [disabled]="isLoading || resetPasswordForm.invalid"
            [class.loading]="isLoading">
            <span class="btn-content">
              <span class="btn-text">
                <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                {{ isLoading ? 'Resetting Password...' : 'Reset Password' }}
              </span>
              <span class="btn-icon">
                <i class="bi" [ngClass]="isLoading ? 'bi-arrow-right-circle-fill' : 'bi-arrow-right-circle-fill'"></i>
              </span>
            </span>
          </button>

          <!-- Back to Login -->
          <div class="back-link-container">
            <a routerLink="/auth/signin" class="back-link">
              <i class="bi bi-arrow-left me-1"></i>
              Back to Login
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
